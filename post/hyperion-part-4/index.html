<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta name="generator" content="Hugo 0.21-DEV" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperion, routeur tout-en-un: Round 3 - Tethys | Xakz&#39;s</title>
    <meta name="description" content="Cr√©ation de la premi√®re VM - notre routeur/firewall
">
    <meta name="keywords" content="linux, xen, admin, network, dnsmasq">
    
    
    
    
    

  <meta name="author" content="Xakz">


    <meta property="og:title" content="Hyperion, routeur tout-en-un: Round 3 - Tethys" />
<meta property="og:description" content="Cr√©ation de la premi√®re VM - notre routeur/firewall
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xakz.github.io/post/hyperion-part-4/" />



<meta property="article:published_time" content="2016-01-29T09:33:12&#43;02:00"/>
<meta property="article:modified_time" content="2016-01-29T09:33:12&#43;02:00"/>











    




    <meta name="theme-color" content="#000">

    
    
    
    <link rel="canonical" href="http://xakz.github.io/post/hyperion-part-4/">
    
      <link rel="prev" href="/post/hyperion-part-3/">
    
    
      <link rel="next" href="/post/hyperion-part-5/">
    
    <link rel="icon" sizes="any" href="data:image/svg+xml,%3Csvg%20viewBox='0%200%2046%2045'%20xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EAfter%20Dark%3C/title%3E%3Cpath%20d='M.708%2045L23%20.416%2045.292%2045H.708zM35%2038L23%2019%2011%2038h24z'%20fill='%23000'/%3E%3C/svg%3E">

    <style>
      html{font-size:12px}*{box-sizing:border-box;text-rendering:geometricPrecision}body{font-size:1rem;line-height:1.5rem;margin:0;font-family:Menlo,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;word-wrap:break-word}h1,h2,h3,h4,h5,h6{line-height:1.3em}fieldset{border:none;padding:0;margin:0}pre{padding:2rem;margin:1.75rem 0;background-color:#fff;border:1px solid #ccc;overflow:auto}code[class*=language-],pre[class*=language-],pre code{font-weight:100;text-shadow:none;margin:1.75rem 0}a{cursor:pointer;color:#ff2e88;text-decoration:none;border-bottom:1px solid #ff2e88}a:hover{background-color:#ff2e88;color:#fff}.grid{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap}.grid.\-top{-ms-flex-align:start;-ms-grid-row-align:flex-start;align-items:flex-start}.grid.\-middle{-ms-flex-align:center;-ms-grid-row-align:center;align-items:center}.grid.\-bottom{-ms-flex-align:end;-ms-grid-row-align:flex-end;align-items:flex-end}.grid.\-stretch{-ms-flex-align:stretch;-ms-grid-row-align:stretch;align-items:stretch}.grid.\-baseline{-ms-flex-align:baseline;-ms-grid-row-align:baseline;align-items:baseline}.grid.\-left{-ms-flex-pack:start;justify-content:flex-start}.grid.\-center{-ms-flex-pack:center;justify-content:center}.grid.\-right{-ms-flex-pack:end;justify-content:flex-end}.grid.\-between{-ms-flex-pack:justify;justify-content:space-between}.grid.\-around{-ms-flex-pack:distribute;justify-content:space-around}.cell{-ms-flex:1;flex:1;box-sizing:border-box}@media screen and (min-width:768px){.cell.\-1of12{-ms-flex:0 0 8.33333%;flex:0 0 8.33333%}.cell.\-2of12{-ms-flex:0 0 16.66667%;flex:0 0 16.66667%}.cell.\-3of12{-ms-flex:0 0 25%;flex:0 0 25%}.cell.\-4of12{-ms-flex:0 0 33.33333%;flex:0 0 33.33333%}.cell.\-5of12{-ms-flex:0 0 41.66667%;flex:0 0 41.66667%}.cell.\-6of12{-ms-flex:0 0 50%;flex:0 0 50%}.cell.\-7of12{-ms-flex:0 0 58.33333%;flex:0 0 58.33333%}.cell.\-8of12{-ms-flex:0 0 66.66667%;flex:0 0 66.66667%}.cell.\-9of12{-ms-flex:0 0 75%;flex:0 0 75%}.cell.\-10of12{-ms-flex:0 0 83.33333%;flex:0 0 83.33333%}.cell.\-11of12{-ms-flex:0 0 91.66667%;flex:0 0 91.66667%}}@media screen and (max-width:768px){.grid{-ms-flex-direction:column;flex-direction:column}.cell{-ms-flex:0 0 auto;flex:0 0 auto}}.hack,.hack blockquote,.hack code,.hack em,.hack h1,.hack h2,.hack h3,.hack h4,.hack h5,.hack h6,.hack strong{font-size:1rem;font-style:normal;font-family:Menlo,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif}.hack blockquote,.hack code,.hack em,.hack strong{line-height:20px}.hack blockquote,.hack code,.hack footer,.hack h1,.hack h2,.hack h3,.hack h4,.hack h5,.hack h6,.hack header,.hack li,.hack ol,.hack p,.hack section,.hack ul{float:none;margin:0;padding:0}.hack blockquote,.hack h1,.hack ol,.hack p,.hack ul{margin-top:20px;margin-bottom:20px}.hack h1{position:relative;display:inline-block;display:table-cell;padding:20px 0 30px;margin:0;overflow:hidden}.hack h1:after{content:"====================================================================================================";position:absolute;bottom:10px;left:0}.hack h1+*{margin-top:0}.hack h2,.hack h3,.hack h4,.hack h5,.hack h6{position:relative;margin-bottom:1.75rem}.hack h2:before,.hack h3:before,.hack h4:before,.hack h5:before,.hack h6:before{display:inline}.hack h2:before{content:"## "}.hack h3:before{content:"### "}.hack h4:before{content:"#### "}.hack h5:before{content:"##### "}.hack h6:before{content:"###### "}.hack li{position:relative;display:block;padding-left:20px}.hack li:after{position:absolute;top:0;left:0}.hack ul>li:after{content:"-"}.hack ol{counter-reset:a}.hack ol>li:after{content:counter(a) ".";counter-increment:a}.hack blockquote{position:relative;padding-left:17px;padding-left:2ch;overflow:hidden}.hack blockquote:after{content:">\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>\A>";white-space:pre;position:absolute;top:0;left:0;line-height:20px}.hack em:after,.hack em:before{content:"*";display:inline}.hack pre code:after,.hack pre code:before{content:''}.hack code{font-weight:700}.hack code:after,.hack code:before{content:"`";display:inline}.hack hr{position:relative;height:20px;overflow:hidden;border:0;margin:20px 0}.hack hr:after{content:"----------------------------------------------------------------------------------------------------";position:absolute;top:0;left:0;line-height:20px;width:100%;word-wrap:break-word}@-moz-document url-prefix(){.hack h1{display:block}}.hack-ones ol>li:after{content:"1."}p{margin:0 0 1.75rem}.container{max-width:70rem}.container,.container-fluid{margin:0 auto;padding:0 1rem}.inner{padding:1rem}.inner2x{padding:2rem}.pull-left{float:left}.pull-right{float:right}.progress-bar{height:8px;opacity:.8;background-color:#ccc;margin-top:12px}.progress-bar.progress-bar-show-percent{margin-top:38px}.progress-bar-filled{background-color:gray;height:100%;transition:width .3s ease;position:relative;width:0}.progress-bar-filled:before{content:'';border:6px solid transparent;border-top-color:gray;position:absolute;top:-12px;right:-6px}.progress-bar-filled:after{color:gray;content:attr(data-filled);display:block;font-size:12px;white-space:nowrap;position:absolute;border:6px solid transparent;top:-38px;right:0;-ms-transform:translateX(50%);transform:translateX(50%)}table{width:100%;border-collapse:collapse;margin:1.75rem 0;color:#778087}table td,table th{vertical-align:top;border:1px solid #ccc;line-height:15px;padding:10px}table thead th{font-size:10px}table tbody td:first-child{font-weight:700;color:#333}.form{width:30rem}.form-group{margin-bottom:1.75rem;overflow:auto}.form-group label{border-bottom:2px solid #ccc;color:#333;width:10rem;display:inline-block;height:38px;line-height:38px;padding:0;float:left;position:relative}.form-group.form-success label{color:#4caf50!important;border-color:#4caf50!important}.form-group.form-warning label{color:#ff9800!important;border-color:#ff9800!important}.form-group.form-error label{color:#f44336!important;border-color:#f44336!important}.form-control{outline:none;border:none;border-bottom:2px solid #ccc;padding:.5rem 0;width:20rem;height:38px;background-color:transparent}.form-control:focus{border-color:#555}.form-group.form-textarea label:after{position:absolute;content:'';width:2px;background-color:#fff;right:-2px;top:0;bottom:0}textarea.form-control{height:auto;resize:none;padding:1rem 0;border-bottom:2px solid #ccc;border-left:2px solid #ccc;padding:.5rem}select.form-control{border-radius:0;background-color:transparent;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none}.help-block{color:#999;margin-top:.5rem}.form-actions{margin-bottom:1.75rem}.btn{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;cursor:pointer;outline:none;padding:.65rem 2rem;font-size:1rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:relative;z-index:1}.btn:active{box-shadow:inset 0 1px 3px rgba(0,0,0,.12)}.btn.btn-ghost{border-color:#757575;color:#757575;background-color:transparent}.btn.btn-ghost:focus,.btn.btn-ghost:hover{border-color:#424242;color:#424242;z-index:2}.btn.btn-ghost:hover{background-color:transparent}.btn-block{width:100%;display:-ms-flexbox;display:flex}.btn-default{color:#fff;background-color:#e0e0e0;border:1px solid #e0e0e0;color:#333}.btn-default:focus:not(.btn-ghost),.btn-default:hover{background-color:#dcdcdc;border-color:#dcdcdc}.btn-success{color:#fff;background-color:#4caf50;border:1px solid #4caf50}.btn-success:focus:not(.btn-ghost),.btn-success:hover{background-color:#43a047;border-color:#43a047}.btn-success.btn-ghost{border-color:#4caf50;color:#4caf50}.btn-success.btn-ghost:focus,.btn-success.btn-ghost:hover{border-color:#388e3c;color:#388e3c;z-index:2}.btn-error{color:#fff;background-color:#f44336;border:1px solid #f44336}.btn-error:focus:not(.btn-ghost),.btn-error:hover{background-color:#e53935;border-color:#e53935}.btn-error.btn-ghost{border-color:#f44336;color:#f44336}.btn-error.btn-ghost:focus,.btn-error.btn-ghost:hover{border-color:#d32f2f;color:#d32f2f;z-index:2}.btn-warning{color:#fff;background-color:#ff9800;border:1px solid #ff9800}.btn-warning:focus:not(.btn-ghost),.btn-warning:hover{background-color:#fb8c00;border-color:#fb8c00}.btn-warning.btn-ghost{border-color:#ff9800;color:#ff9800}.btn-warning.btn-ghost:focus,.btn-warning.btn-ghost:hover{border-color:#f57c00;color:#f57c00;z-index:2}.btn-info{color:#fff;background-color:#00bcd4;border:1px solid #00bcd4}.btn-info:focus:not(.btn-ghost),.btn-info:hover{background-color:#00acc1;border-color:#00acc1}.btn-info.btn-ghost{border-color:#00bcd4;color:#00bcd4}.btn-info.btn-ghost:focus,.btn-info.btn-ghost:hover{border-color:#0097a7;color:#0097a7;z-index:2}.btn-primary{color:#fff;background-color:#2196f3;border:1px solid #2196f3}.btn-primary:focus:not(.btn-ghost),.btn-primary:hover{background-color:#1e88e5;border-color:#1e88e5}.btn-primary.btn-ghost{border-color:#2196f3;color:#2196f3}.btn-primary.btn-ghost:focus,.btn-primary.btn-ghost:hover{border-color:#1976d2;color:#1976d2;z-index:2}.btn-group{overflow:auto}.btn-group .btn{float:left}.btn-group .btn-ghost:not(:first-child){margin-left:-1px}.card{border:1px solid #ccc}.card .card-header{color:#333;text-align:center;background-color:#ddd;padding:.5rem 0}.alert{color:#ccc;padding:1rem;border:1px solid #ccc;margin-bottom:1.75rem}.alert-success{color:#4caf50;border-color:#4caf50}.alert-error{color:#f44336;border-color:#f44336}.alert-info{color:#00bcd4;border-color:#00bcd4}.alert-warning{color:#ff9800;border-color:#ff9800}.media:not(:last-child){margin-bottom:1.25rem}.media-left{padding-right:1rem}.media-left,.media-right{display:table-cell;vertical-align:top}.media-right{padding-left:1rem}.media-body{display:table-cell;vertical-align:top}.media-heading{font-size:1.16667rem;font-weight:700}.media-content{margin-top:.3rem}.avatarholder,.placeholder{background-color:#f0f0f0;text-align:center;color:#b9b9b9;font-size:1rem;border:1px solid #f0f0f0}.avatarholder{width:48px;height:48px;line-height:46px;font-size:2rem;background-size:cover;background-position:50%;background-repeat:no-repeat}.avatarholder.rounded{border-radius:33px}.loading{height:20px;width:20px;animation:a .6s infinite linear;border:2px solid #e91e63;border-right-color:transparent;border-radius:50%}.btn .loading{display:inline-block;float:left;margin-right:.5rem;width:14px;height:14px}@keyframes a{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.menu{width:100%}.menu .menu-item{display:block;color:#616161;border-color:#616161}.menu .menu-item.active,.menu .menu-item:hover{color:#000;border-color:#000;background-color:transparent}@media screen and (max-width:768px){.form-group label{display:block;border-bottom:none;width:100%}.form-group.form-textarea label:after{display:none}.form-control{width:100%}textarea.form-control{border-left:none;padding:.5rem 0}pre::-webkit-scrollbar{height:3px}}@media screen and (max-width:480px){.form{width:100%}}
.dark{color:#ccc}.dark,.dark pre{background-color:#000}.dark pre{padding:0;border:none}.dark pre code{color:#00bcd4}.dark h1 a,.dark h2 a,.dark h3 a,.dark h4 a,.dark h5 a{color:#ccc}.dark code,.dark strong{color:#fff}.dark code{font-weight:100}.dark table{color:#ccc}.dark table td,.dark table th{border-color:#444}.dark table tbody td:first-child{color:#fff}.dark .form-group label{color:#ccc;border-color:rgba(95,95,95,.78)}.dark .form-group.form-textarea label:after{background-color:#000}.dark .form-control{color:#ccc;border-color:rgba(95,95,95,.78)}.dark .form-control:focus{border-color:#ccc;color:#ccc}.dark textarea.form-control{color:#ccc}.dark .card{border-color:rgba(95,95,95,.78)}.dark .card .card-header{background-color:transparent;color:#ccc;border-bottom:1px solid rgba(95,95,95,.78)}.dark .btn.btn-ghost.btn-default{border-color:#ababab;color:#ababab}.dark .btn.btn-ghost.btn-default:focus,.dark .btn.btn-ghost.btn-default:hover{border-color:#9c9c9c;color:#9c9c9c;z-index:1}.dark .btn.btn-ghost.btn-default:focus,.dark .btn.btn-ghost.btn-default:hover{border-color:#e0e0e0;color:#e0e0e0}.dark .btn.btn-ghost.btn-primary:focus,.dark .btn.btn-ghost.btn-primary:hover{border-color:#64b5f6;color:#64b5f6}.dark .btn.btn-ghost.btn-success:focus,.dark .btn.btn-ghost.btn-success:hover{border-color:#81c784;color:#81c784}.dark .btn.btn-ghost.btn-info:focus,.dark .btn.btn-ghost.btn-info:hover{border-color:#4dd0e1;color:#4dd0e1}.dark .btn.btn-ghost.btn-error:focus,.dark .btn.btn-ghost.btn-error:hover{border-color:#e57373;color:#e57373}.dark .btn.btn-ghost.btn-warning:focus,.dark .btn.btn-ghost.btn-warning:hover{border-color:#ffb74d;color:#ffb74d}.dark .avatarholder,.dark .placeholder{background-color:transparent;border-color:#333}.dark .menu .menu-item{color:#ccc;border-color:rgba(95,95,95,.78)}.dark .menu .menu-item.active,.dark .menu .menu-item:hover{color:#fff;border-color:#ccc}

      @keyframes intro {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
.muted {
  color: rgba(255, 255, 255, 0.5);
}
main, footer {
  animation: intro 0.3s both;
  animation-delay: 0.15s;
}
:target {
  color: #fff;
}
/* hack.css overrides and enhancements */
.hack li ul {
  margin: 0;
}
.main {
  padding: 20px 10px;
}
nav a.active {
  background-color: #ff2e88;
  color: #fff;
}
a[itemprop="url"] {
  color: #ff9800;
}
a[itemprop="url"]:hover {
  color: #fff;
}
a[href*="//"]::after {
  /* data uri svg icon. thanks to @Fastidious for the idea */
  content: " " url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20class='i-external'%20viewBox='0%200%2032%2032'%20width='14'%20height='14'%20fill='none'%20stroke='%23ff9800'%20stroke-linecap='round'%20stroke-linejoin='round'%20stroke-width='9.38%'%3E%3Cpath%20d='M14%209%20L3%209%203%2029%2023%2029%2023%2018%20M18%204%20L28%204%2028%2014%20M28%204%20L14%2018'/%3E%3C/svg%3E");
}
html {
  font-size: 13px;
}
.hack pre {
  font-size: 17px;
}
article [itemprop="description"] {
  margin-bottom: 20px;
  margin-top: 20px;
}
p {
  hyphens: auto;
  text-align: justify;
}
@media screen and (min-width: 768px) {
  html {
    font-size: 1em;
  }
  .container {
    max-width: 50rem;
  }
}

      
/* the modern clearfix */
.group:after {
  content: "";
  display: table;
  clear: both;
}

figure
{
 display: block;
 position: relative;
 float: left;
 overflow: hidden;
 margin: 0 1% 1% 0;
 }

figcaption
{
 position: absolute;
 background: black;
 background: rgba(0,0,0,0.75);
 color: white;
 padding: 10px 20px;
 opacity: 0;
 transition: all 0.6s ease;
 }

figure img
{
 width: 1024px;
 max-width: 100%;
 }

figure:hover figcaption { opacity: 1; }

figure:before
{
 content: "?";
 position: absolute;
 font-weight: 800;
 background: black;
 background: rgba(255,255,255,0.75);
 text-shadow: 0 0 5px white;
 color: black;
 width: 24px;
 height: 24px;
 border-radius: 12px;
 text-align: center;
 font-size: 14px;
 line-height: 24px;
 transition: all 0.6s ease;
 opacity: 0.75;
 }

figure:hover:before { opacity: 0; }

.cap-left:before { bottom: 10px; left: 10px; }
.cap-left figcaption { bottom: 0; left: -30%; }
.cap-left:hover figcaption { left: 0; }

.cap-right:before { bottom: 10px; right: 10px; }
.cap-right figcaption { bottom: 0; right: -30%; }
.cap-right:hover figcaption { right: 0; }

.cap-top:before { top: 10px; left: 10px; }
.cap-top figcaption { left: 0; top: -30%; }
.cap-top:hover figcaption { top: 0; }

.cap-bot:before { bottom: 10px; left: 10px; }
.cap-bot figcaption { left: 0; bottom: -30%;}
.cap-bot:hover figcaption { bottom: 0; }

    </style>
    
    
  </head>
  
  <body class="hack dark main container">
    <header>
  
  <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
    
    
      <a itemprop="url" class="" href="/"><span itemprop="name">Home</span></a>
    
      <a itemprop="url" class="active" href="/post/"><span itemprop="name">Posts</span></a>
    
      <a itemprop="url" class="" href="/categories/"><span itemprop="name">Cat√©gories</span></a>
    
      <a itemprop="url" class="" href="/tags/"><span itemprop="name">Tags</span></a>
    
  </nav>


</header>
    <main>
  <article itemscope itemtype="http://schema.org/BlogPosting">
    
<meta itemprop="name" content="Hyperion, routeur tout-en-un: Round 3 - Tethys">
<meta itemprop="description" content="Cr√©ation de la premi√®re VM - notre routeur/firewall
">


<meta itemprop="dateModified" content="2016-01-29T09:33:12&#43;02:00" />
<meta itemprop="wordCount" content="1357">



<meta itemprop="keywords" content="administration,big-data,coding,hyperion,admin,bigdata,bridge,debian,dnsmasq,git,github-pages,hadoop,hardware,hugo,linux,makefile,network,xen," />

    <header>
      <h1 itemprop="headline">Hyperion, routeur tout-en-un: Round 3 - Tethys</h1>
      <p class="muted"><svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
  <circle cx="16" cy="16" r="14" />
  <path d="M16 8 L16 16 20 20" />
</svg>
<span>7 minute read</span>
<svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
  <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z" />
</svg>

  Published: <time datetime="2016-01-29T09:33:12&#43;02:00">29 Jan, 2016</time>

</p>
    </header>
    
      <blockquote itemprop="description">Cr√©ation de la premi√®re VM - notre routeur/firewall
</blockquote>
    
    
  <details>
    <summary>Table of Contents</summary>
    <nav id="TableOfContents">
<ul>
<li><a href="#xen-create-image">xen-create-image</a></li>
<li><a href="#petits-ajustements">Petits ajustements</a></li>
<li><a href="#premier-boot">Premier boot</a></li>
<li><a href="#configuration-r√©seau">Configuration r√©seau</a></li>
<li><a href="#init">Init</a></li>
<li><a href="#routage-et-nat">routage et NAT</a></li>
<li><a href="#dns-et-dhcp">DNS et DHCP</a></li>
<li><a href="#le-prochain-post">Le prochain post</a></li>
</ul>
</nav>
  </details>
  <script>
    const el = document.querySelector('details summary')
    el.onclick = () => {
      (function(l,o,a,d,e,r){e=o.createElement(a),r=o.getElementsByTagName(a)[0];e.async=1;e.src=d;r.parentNode.insertBefore(e,r)})(window,document,'script','/js/smoothscroll.js');
      el.onclick = null
    }
    document.querySelectorAll('#TableOfContents a').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelector(
          link.href.slice(link.href.indexOf('#'))
        ).scrollIntoView({ behavior: 'smooth' })
      })
    })
  </script>


    <div itemprop="articleBody">
      <p>Voil√†, toute la tuyauterie cot√© dom0 est en place, il nous faut maintenant cr√©er
le domU du routeur-firewall, nomm√© <code>tethys</code>.</p>

<p></p>

<h1 id="xen-create-image">xen-create-image</h1>

<p>Xen est fourni avec une s√©rie d'outils pour faciliter la mise en place de VMs
(paquet <code>xen-tools</code>), utilisons les !</p>

<pre><code class="language-sh">xen-create-image --verbose --hostname=tethys --memory=128M --vcpus=1 --size=2G --swap=128M --lvm=vg0 --nodhcp --pygrub --dist=jessie
</code></pre>

<p>Cette commande va utiliser <a href="https://wiki.debian.org/fr/Debootstrap" target="_blank">debootstrap</a> et une s√©rie de script pour g√©n√©rer une
image Debian bootable. Les options sont plut√¥t explicite et parlent d'elle-m√™me:
128M de RAM, 1 Virtual CPU, 2G de disque, 128M de SWAP, disque et SWAP √† cr√©er
sur <code>vg0</code>, pas de DHCP, <a href="https://wiki.xen.org/wiki/PyGrub" target="_blank">pygrub</a> (un emulateur de GRUB en python adapt√© √†
Xen), et la version de Debian: Jessie (Debian 8).</p>

<p>Laisse la magie op√©rer... Devant un petit caf√© √©ventuellement üòâ</p>

<p>√Ä la fin, le script donnera un petit r√©sum√©, le plus important ici c'est de
copier le mot de passe root dans un coin !</p>

<h1 id="petits-ajustements">Petits ajustements</h1>

<p>De base, <code>xen-create-image</code> pr√©pare des VMs simples, en particulier, elles ne
poss√®dent qu'une seule interface r√©seau. Ici, on veut faire un routeur, avec X
interfaces. On va donc ajuster quelques peu le fichier de configuration de la
VMs</p>

<p>Le voici:</p>

<pre><code class="language-sh">#
# Configuration file for the Xen instance tethys, created
# by xen-tools 4.5 on Mon Dec 28 07:25:34 2015.
#

#
#  Kernel + memory size
#


bootloader = '/usr/lib/xen-4.4/bin/pygrub'

vcpus       = '1'
memory      = '128'


#
#  Disk device(s).
#
root        = '/dev/xvda2 ro'
disk        = [
                  'phy:/dev/vg0/tethys-disk,xvda2,w',
                  'phy:/dev/vg0/tethys-swap,xvda1,w',
              ]


#
#  Physical volumes
#


#
#  Hostname
#
name        = 'tethys'

#
#  Networking
#
#dhcp        = 'dhcp'
vif         =	[ 
	 	'mac=00:16:3E:CA:6B:D0,bridge=brinet0', 
		'mac=00:16:3E:CA:6B:D1,bridge=brlan0',
		'mac=00:16:3E:CA:6B:D2,bridge=brap0', 
		'mac=00:16:3E:CA:6B:D3,bridge=brdmz0', 
		'mac=00:16:3E:CA:6B:D4,bridge=brcmz0', 
		'mac=00:16:3E:CA:6B:D5,bridge=brcluster0' 
		]

#
#  Behaviour
#
on_poweroff = 'destroy'
on_reboot   = 'restart'
on_crash    = 'restart'
</code></pre>

<p>La grande diff√©rence est la variable <code>vif</code>, je d√©fini 6 interfaces r√©seau li√©es
aux 6 bridges pr√©sents sur Hyperion (Je sugg√®re de rejetter un coup d'oeil sur
le <a href="/post/hyperion-part-3/#sch√©ma-en-ascii">sch√©ma</a> du r√©seau virtuel). J'y d√©fini aussi leur adresse MAC.</p>

<h1 id="premier-boot">Premier boot</h1>

<p>Rien de plus simple:</p>

<pre><code class="language-sh">xl create /etc/xen/tethys.cfg
</code></pre>

<p>Afin que la VMs d√©marre automatiquement avec Hyperion il faut faire cela:</p>

<pre><code class="language-sh">mkdir /etc/xen/auto
ln -s ../tethys.cfg /etc/xen/auto/tethys.cfg
</code></pre>

<p>La machine a boot√©, on peut la voir avec <code>xentop</code>.</p>

<p>Th√©oriquement, on pourrait se connecter en SSH dessus directement, mais
actuellement, 2 choses ne vont pas:</p>

<ul>
<li>Pas de DHCP, donc aucunes des 6 interfaces ne poss√®dent d'adresse IP</li>
<li>Le serveur SSH install√© par d√©faut n'accepte pas que root se connecte en
utilisant un mot de passe (uniquement des cl√©s SSH) et aucun utilisateur n'a
√©t√© cr√©√©.
<br /></li>
</ul>

<h1 id="configuration-r√©seau">Configuration r√©seau</h1>

<p>Commen√ßons pas nous connecter sur la machine. Sans SSH c'est possible car xen
fourni une console virtuelle sur port s√©rie.</p>

<p>Un simple <code>xl console tethys</code> et nous y voil√†, login: root, password: celui
copier lors de la cr√©ation de la VM. Pour quitter la console un simple <code>ctrl-]</code>
suffit.</p>

<p>Comme sur Hyperion, on va donner des noms un peu plus parlants que eth0, eth1,
eth2, etc...</p>

<p>Dans <code>/etc/udev/rules.d/70-persistent-net.rules</code>:</p>

<pre><code class="language-sh">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{address}==&quot;00:16:3e:ca:6b:d0&quot;, NAME=&quot;inet0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{address}==&quot;00:16:3e:ca:6b:d1&quot;, NAME=&quot;lan0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{address}==&quot;00:16:3e:ca:6b:d2&quot;, NAME=&quot;ap0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{address}==&quot;00:16:3e:ca:6b:d3&quot;, NAME=&quot;dmz0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{address}==&quot;00:16:3e:ca:6b:d4&quot;, NAME=&quot;cmz0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR{address}==&quot;00:16:3e:ca:6b:d5&quot;, NAME=&quot;cluster0&quot;
</code></pre>

<p>Et dans la foul√©e, on va aussi donner des adresses IP a tout ce petit monde.</p>

<p>Dans <code>/etc/network/interfaces</code>:</p>

<pre><code class="language-sh"># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

auto inet0
iface inet0 inet static
	address 192.168.1.1
	netmask 255.255.255.0
	gateway 192.168.1.254

auto lan0
iface lan0 inet static
	address 10.0.0.1
	netmask 255.255.0.0		

auto ap0
iface ap0 inet static
	address 10.1.0.1
	netmask 255.255.0.0		

auto dmz0
iface dmz0 inet static
	address 10.5.0.1
	netmask 255.255.0.0

auto cmz0
iface cmz0 inet static
	address 10.6.0.1
	netmask 255.255.0.0

auto cluster0
iface cluster0 inet static
	address 10.10.0.1
	netmask 255.255.0.0
</code></pre>

<p>Et aussi, pourquoi, ajoutons notre cl√© SSH aux cl√©s authoris√©es pour root (si
vous n'avez pas de cl√© SSH, utilisez <code>ssh-keygen</code>):</p>

<pre><code class="language-sh">mkdir /root/.ssh
cat &gt; /root/.ssh/authorized_keys
&lt;copiez-collez votre cl√© publique ici (~/.ssh/id_rsa.pub) et terminez par ctrl-d&gt;
</code></pre>

<p>Voil√†, et hop ! Un reboot !</p>

<p>En principe, on peut maintenant se connecter en SSH sur tethys avec un <code>ssh root@10.0.0.1</code>.</p>

<h1 id="init">Init</h1>

<p>Par d√©faut, Debian 8 est install√© avec systemd, personnellement je n'ai rien
contre, il s'av√®re m√™me tr√®s pratique sur les machines desktop (en plus sous
Arch Linux il n'y a que lui). Par contre pour un serveur comme <code>tethys</code>, je vais
pr√©f√©rer le system de boot classique: <a href="https://fr.wikipedia.org/wiki/Init" target="_blank">init</a>.</p>

<ol>
<li><code>apt-get --purge install sysvinit-core</code></li>
<li><code>echo &quot;co:2345:respawn:/sbin/getty hvc0 9600 linux&quot; &gt;&gt; /etc/inittab</code> (c'est
pour avoir la console s√©rie virtuelle avec Xen (xl console tethys))</li>
<li><code>reboot</code></li>
<li><code>apt-get --purge remove systemd</code></li>
</ol>

<h1 id="routage-et-nat">routage et NAT</h1>

<p>Bon c'est pas mal, mais √ßa route pas ! Par d√©faut linux ne route pas les paquets
entre les interfaces. On va rem√®dier √† cela.</p>

<p>Dans un fichier cr√©√© pour l'occasion <code>/etc/sysctl.d/50-forwarding.conf</code>:</p>

<pre><code class="language-sh">net.ipv4.ip_forward=1
net.ipv4.conf.default.forwarding=1
net.ipv4.conf.all.forwarding=1
net.ipv6.conf.default.forwarding=1
net.ipv6.conf.all.forwarding=1
</code></pre>

<p>Voil√†, routage IPv4 et IPv6.</p>

<p>Ensuite, le NAT, la box du FAI ne connait rien du r√©seau 10.x.x.x, On va donc
faire du NAT sur <code>tethys</code> en utilisant <a href="https://fr.wikipedia.org/wiki/Netfilter" target="_blank">Netfilter</a>, le framework du kernel
pour tout ce qui touche de pr√®s ou de loin au firewall.</p>

<pre><code class="language-sh">iptables -t nat -A POSTROUTING -o inet0 -j MASQUERADE
</code></pre>

<p>En principe, maintenant, on peut se connecter sur internet √† condition
d'utiliser le DNS de la Box (192.168.1.254). On va arranger √ßa tout de suite.</p>

<h1 id="dns-et-dhcp">DNS et DHCP</h1>

<p>Je pourrais installer <a href="https://fr.wikipedia.org/wiki/BIND" target="_blank">Bind</a> et <a href="https://en.wikipedia.org/wiki/DHCPD" target="_blank">DHCPD</a>, mais autant DHCPD √ßa va, autant
Bind c'est vraiment trop pour nos besoins. Il existe
mieux: <a href="https://fr.wikipedia.org/wiki/Dnsmasq" target="_blank">dnsmasq</a>. Wikipedia dit &quot;petits r√©seaux famillial&quot; mais il peut
parfaitement g√©rer tout un r√©seau d'entreprise √† lui tout seul si on a pas
besoin de fonctions avanc√©es comme le transfert de zone, le stockage de zone
dans des bases de donn√©es, etc... Dnsmasq est typiquement un cache DNS de
r√©solution de nom de domaine avec DHCP int√©gr√© (il fait m√™me TFTP et Boostrap
pour booter vos machine par le r√©seau). En plus, la configuration est tr√®s simple.</p>

<p>Allez !</p>

<pre><code>apt-get install dnsmasq
</code></pre>

<p>Dans <code>/etc/dnsmasq.d/10core.conf</code> (n'importe quel nom en .conf conviendrait):</p>

<pre><code># The domain
domain=rxsoft.eu

# Do not read resolv.conf
no-resolv

# Upstream servers
## OpenNic (http://servers.opennicproject.org/)
### Any Cast
server=185.121.177.177
server=2a05:dfc7:5::53
server=185.121.177.53
server=2a05:dfc7:5::5353
server=185.190.82.182
server=2a0b:1904:0:53::
### FR
server=87.98.175.85
server=2001:41d0:2:73d4::100
### FR
server=5.135.183.146
server=2001:41d0:8:be92::1
### DE
server=5.9.49.12
server=2a01:4f8:161:4109::6
### IT
server=193.183.98.154
server=2a00:dcc0:eda:98:183:193:d85a:389b
### NL
server=185.133.72.100
server=2a05:b0c6:5e4::53
### RO
server=89.18.27.34
server=2001:470:1f15:235::1
## FreeDNS
#server=37.235.1.174
#server=37.235.1.177
## Google
#server=8.8.8.8
#server=8.8.4.4
## ISP box DNS
#server=192.168.1.254

# On which interface to listen for DNS/DHCP request
interface=lan0
interface=ap0
interface=dmz0
interface=cmz0
interface=cluster0
no-dhcp-interface=dmz0
no-dhcp-interface=cmz0
no-dhcp-interface=cluster0

# Don not read /etc/hosts
no-hosts
# Read this one instead
addn-hosts=/etc/hosts.local
# Expand name without dot with the local domain name in the hosts file
expand-hosts
</code></pre>

<ul>
<li>J'ai mis une longue liste de DNS &quot;libres&quot; pour √™tre s√ªr de na pas avoir de
coupure au niveau du DNS.</li>
<li>Je lui dit de travailler sur toutes les interfaces sauf celle connect√©e √† la
box du FAI.</li>
<li>DHCP uniquement pour le LAN et le WIFI, les autres sous r√©seaux seront en IP
statique.</li>
<li>Le fichier <code>/etc/hosts.local</code> sera une mini DB de nom DNS locaux, au m√™me
format que <code>/etc/hosts</code>.
<br /></li>
</ul>

<p>Et dans <code>/etc/dnsmasq.d/20dhcp.conf</code>:</p>

<pre><code>dhcp-range=10.0.0.10,10.0.0.200,2h
dhcp-range=10.1.0.10,10.1.0.200,2h
dhcp-option=option:dns-server,10.0.0.1
dhcp-authoritative
</code></pre>

<ul>
<li>Les plages d'adresses IP pour les sous r√©seau du LAN et du WIFI.</li>
<li>O√π se trouve le serveur DNS.</li>
<li>Le DHCP est le seul du r√©seau.</li>
</ul>

<p>Et voil√† ! Un petit red√©marrage de dnsmasq et tout l'Internet devrait s'ouvrir a
vous.</p>

<p>Il reste un petit quelques chose √† faire, rendre les r√©glages Netfilter
persistants entre les reboot.</p>

<p>Il y a plusieurs solutions, je vais prendre la plus √©l√©mentaire: 3 lignes dans
<code>/etc/rc.local</code>. Mais il y a aussi le paquet <code>iptables-persistent</code> par exemple.</p>

<p>Dans <code>/etc/rc.local</code>:</p>

<pre><code class="language-sh"># Active le NAT sur inet0
iptables -t nat -A POSTROUTING -o inet0 -j MASQUERADE

# Il y a un bug dans dnsmasq (ou dhcp-client, je suis pas s√ªr) qui fait que le
# checksum UDP est incorrect, ces 2 r√®gles Netfilter arrange le probl√®me.
iptables -t mangle -A POSTROUTING -o lan0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
iptables -t mangle -A POSTROUTING -o ap0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
</code></pre>

<h1 id="le-prochain-post">Le prochain post</h1>

<p>Au <a href="/post/hyperion-part-5/">prochain post</a>, Il faudra se concentrer sur les r√©glages kernel et
Netfilter pour la s√©curit√©.</p>
    </div>
    
    <footer>
      <hr>
      <p>
  Published
  
    
      by <span itemprop="author">Xakz</span>
    
  
  <time datetime="2016-01-29T09:33:12&#43;02:00">
    29 Jan, 2016
  </time>
  
    in <span itemprop="articleSection"><a href="/categories/administration/">Administration</a> and <a href="/categories/hyperion/">Hyperion</a></span>
  
  
    and tagged <a href="/tags/admin/">admin</a>, <a href="/tags/dnsmasq/">dnsmasq</a>, <a href="/tags/linux/">linux</a>, <a href="/tags/network/">network</a> and <a href="/tags/xen/">xen</a>
  
  using <span itemprop="wordCount">1357</span> words.
</p>

      
  



  <aside>
    <header>Related Content</header>
    <ul>
      
      
        <li><a href="/post/hadoop-dev-server/">Installer un pseudo-cluster Hadoop</a> &ndash; 5 minutes
      
        <li><a href="/post/hyperion-part-3/">Hyperion, routeur tout-en-un: Round 2 - Le r√©seau</a> &ndash; 11 minutes
      
        <li><a href="/post/hyperion-part-2/">Hyperion, routeur tout-en-un: Round 1 - Xen</a> &ndash; 9 minutes
      
        <li><a href="/post/hyperion-part-1/">Hyperion, routeur tout-en-un: Round 0 - Pr√©ambule</a> &ndash; 4 minutes
      
    </ul>
  </aside>


    </footer>
  </article>
</main>
    <footer>
  
  <p class="muted">
    This page was generated using
    <a target="_blank" rel="noopener" href="https://comfusion.github.io/after-dark/">After Dark</a>
    for
    <a target="_blank" rel="noopener" href="https://gohugo.io/">Hugo</a>.
  </p>


</footer>
  </body>
</html>
